<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Absensi Siswa Real-Time</title>
    
    <!-- Tailwind CSS (Desain Modern) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome (Ikon) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PapaParse (Membaca Data CSV Google Sheets) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <!-- SweetAlert2 (Popup Notifikasi) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- SheetJS (Opsional untuk Export Excel jika dibutuhkan nanti, tapi kita pakai Print browser) -->

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #f0f2f5; 
        }

        /* Animasi Loading */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* Konfigurasi Tampilan Cetak (Print) */
        @media print {
            @page { size: landscape; margin: 10mm; }
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                background: white;
                color: black;
            }
            .no-print { display: none !important; }
            table { width: 100%; border-collapse: collapse; border: 1px solid black; }
            th, td { border: 1px solid black !important; padding: 8px; font-size: 12px; }
            th { background-color: #eee !important; -webkit-print-color-adjust: exact; }
            /* Sembunyikan card statistik saat print agar hemat tinta */
            .stats-container { display: none; } 
            /* Tampilkan header laporan khusus print */
            .print-header { display: block !important; text-align: center; margin-bottom: 20px; }
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Navbar Sederhana -->
    <nav class="bg-blue-600 text-white p-4 shadow-md no-print">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-school text-xl"></i>
                <h1 class="font-bold text-lg hidden md:block">Sistem Absensi Terpadu</h1>
                <h1 class="font-bold text-lg md:hidden">E-Absensi</h1>
            </div>
            <!-- GANTI LINK INI DENGAN LINK FORM GOOGLE ANDA YANG ASLI -->
            <a href="https://forms.google.com/" target="_blank" class="bg-white text-blue-600 px-4 py-2 rounded-full font-bold text-sm hover:bg-blue-50 transition shadow-lg animate-pulse">
                <i class="fas fa-pen-to-square mr-1"></i> Absen Masuk
            </a>
        </div>
    </nav>

    <!-- HALAMAN LOGIN -->
    <div id="login-page" class="min-h-[80vh] flex items-center justify-center p-4">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-md border-t-4 border-blue-600">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Selamat Datang</h2>
                <p class="text-gray-500 text-sm">Silakan pilih akses masuk Anda</p>
            </div>

            <!-- Tab Switcher -->
            <div class="flex p-1 bg-gray-100 rounded-xl mb-6">
                <button onclick="switchTab('guru')" id="btn-tab-guru" class="flex-1 py-2 rounded-lg text-sm font-bold bg-white text-blue-600 shadow-sm transition">
                    <i class="fas fa-chalkboard-user mr-1"></i> Guru
                </button>
                <button onclick="switchTab('wali')" id="btn-tab-wali" class="flex-1 py-2 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-700 transition">
                    <i class="fas fa-user-group mr-1"></i> Wali Siswa
                </button>
            </div>

            <!-- Form Guru -->
            <div id="form-guru" class="fade-in">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-600 mb-1">PASSWORD ADMIN</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-3 top-3 text-gray-400"></i>
                        <input type="password" id="pass-guru" class="w-full pl-10 p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Masukkan Password Guru">
                    </div>
                </div>
                <button onclick="loginGuru()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg transform active:scale-95">
                    Masuk Dashboard Guru
                </button>
            </div>

            <!-- Form Wali -->
            <div id="form-wali" class="hidden fade-in">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-600 mb-1">NAMA SISWA</label>
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" id="nama-siswa-wali" class="w-full pl-10 p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none" placeholder="Contoh: Ahmad, Siti...">
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1">*Cukup ketik nama depan atau nama panggilan.</p>
                </div>
                <button onclick="loginWali()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition shadow-lg transform active:scale-95">
                    Cek Kehadiran Anak
                </button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD GURU -->
    <div id="dashboard-guru" class="hidden p-4 md:p-6 max-w-7xl mx-auto">
        <div id="print-area">
            <!-- Header Dashboard -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 no-print">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-chart-line text-blue-600 mr-2"></i>Dashboard Rekapitulasi</h2>
                    <p class="text-sm text-gray-500" id="last-update-guru">Data terakhir diperbarui: -</p>
                </div>
                <button onclick="logout()" class="mt-4 md:mt-0 bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-200 transition">
                    <i class="fas fa-sign-out-alt mr-1"></i> Keluar
                </button>
            </div>

            <!-- Header Khusus Print (Hidden by default) -->
            <div class="print-header hidden">
                <h2 class="text-xl font-bold">LAPORAN KEHADIRAN SISWA</h2>
                <p id="print-subtitle" class="text-sm">Periode: Semua Data</p>
                <hr class="my-4 border-black">
            </div>

            <!-- Filter Controls (No Print) -->
            <div class="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-col md:flex-row gap-4 border border-gray-100 no-print">
                <div class="flex-1">
                    <label class="block text-xs font-bold text-gray-500 mb-1">FILTER BULAN</label>
                    <input type="month" id="filter-bulan" class="w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" onchange="renderGuruData()">
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-bold text-gray-500 mb-1">FILTER KELAS</label>
                    <select id="filter-kelas" class="w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" onchange="renderGuruData()">
                        <option value="Semua">Semua Kelas</option>
                        <!-- Opsi kelas generate by JS -->
                    </select>
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-bold text-gray-500 mb-1">CARI NAMA</label>
                    <input type="text" id="search-guru" placeholder="Ketik nama siswa..." class="w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" onkeyup="renderGuruData()">
                </div>
                <div class="flex items-end">
                    <button onclick="window.print()" class="w-full md:w-auto bg-gray-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-gray-900 transition shadow">
                        <i class="fas fa-print mr-2"></i> Cetak
                    </button>
                </div>
            </div>

            <!-- Statistik Cards -->
            <div class="stats-container grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-xl border-l-4 border-blue-500">
                    <div class="text-xs text-gray-500 font-bold uppercase">Total Data</div>
                    <div class="text-2xl font-bold text-blue-700" id="stat-total">0</div>
                </div>
                <div class="bg-green-50 p-4 rounded-xl border-l-4 border-green-500">
                    <div class="text-xs text-gray-500 font-bold uppercase">Hadir</div>
                    <div class="text-2xl font-bold text-green-700" id="stat-hadir">0</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-xl border-l-4 border-yellow-500">
                    <div class="text-xs text-gray-500 font-bold uppercase">Izin / Sakit</div>
                    <div class="text-2xl font-bold text-yellow-700" id="stat-izin">0</div>
                </div>
                <div class="bg-red-50 p-4 rounded-xl border-l-4 border-red-500">
                    <div class="text-xs text-gray-500 font-bold uppercase">Kehadiran</div>
                    <div class="text-2xl font-bold text-red-700" id="stat-persen">0%</div>
                </div>
            </div>

            <!-- Tabel Data -->
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-gray-700 uppercase font-bold text-xs">
                            <tr>
                                <th class="p-3 border-b">Tanggal</th>
                                <th class="p-3 border-b">Nama Siswa</th>
                                <th class="p-3 border-b text-center">Kelas</th>
                                <th class="p-3 border-b text-center">Status</th>
                                <th class="p-3 border-b">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody id="tabel-guru-body" class="divide-y divide-gray-100 text-gray-600">
                            <!-- Data Row -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Loading & Empty State -->
                <div id="loading-guru" class="hidden text-center py-10">
                    <div class="loader"></div>
                    <p class="text-gray-400 text-sm mt-2">Sedang mengambil data...</p>
                </div>
                <div id="empty-guru" class="hidden text-center py-10 text-gray-400">
                    <i class="fas fa-folder-open text-4xl mb-2"></i>
                    <p>Tidak ada data ditemukan sesuai filter.</p>
                </div>
            </div>
            
            <div class="mt-4 text-xs text-gray-400 italic no-print">
                * Catatan: Fitur deteksi 'Alpa' hanya dapat berfungsi jika sistem memiliki database seluruh siswa. Saat ini sistem menampilkan rekapitulasi berdasarkan data yang masuk (Hadir/Izin).
            </div>
        </div>
    </div>

    <!-- DASHBOARD WALI -->
    <div id="dashboard-wali" class="hidden p-4 md:p-8 max-w-lg mx-auto min-h-screen bg-white shadow-2xl">
        <div class="flex items-center mb-6">
            <button onclick="logout()" class="mr-4 bg-gray-100 p-2 rounded-full hover:bg-gray-200 transition">
                <i class="fas fa-arrow-left text-gray-600"></i>
            </button>
            <h2 class="text-xl font-bold text-gray-800">Profil Kehadiran</h2>
        </div>

        <!-- Profil Card -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl p-6 text-white text-center shadow-lg mb-6">
            <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 text-3xl backdrop-blur-sm border-2 border-white/30">
                <i class="fas fa-user-graduate"></i>
            </div>
            <h3 class="text-xl font-bold truncate" id="wali-nama">-</h3>
            <p class="text-blue-100 text-sm mb-4" id="wali-kelas">-</p>
            
            <div class="flex justify-center gap-4 text-center">
                <div class="bg-white/10 rounded-lg p-2 flex-1 backdrop-blur-sm">
                    <div class="text-xs opacity-75">Hadir</div>
                    <div class="font-bold text-lg" id="wali-hadir">0</div>
                </div>
                <div class="bg-white/10 rounded-lg p-2 flex-1 backdrop-blur-sm">
                    <div class="text-xs opacity-75">Izin/Sakit</div>
                    <div class="font-bold text-lg" id="wali-izin">0</div>
                </div>
                <div class="bg-white/10 rounded-lg p-2 flex-1 backdrop-blur-sm">
                    <div class="text-xs opacity-75">Persentase</div>
                    <div class="font-bold text-lg" id="wali-persen">0%</div>
                </div>
            </div>
        </div>

        <h3 class="font-bold text-gray-800 mb-4 border-l-4 border-blue-600 pl-3">Riwayat Absensi</h3>
        <div id="wali-timeline" class="space-y-4">
            <!-- Timeline Item -->
        </div>
        <div id="wali-empty" class="hidden text-center py-10 text-gray-400">
            <p>Belum ada riwayat absensi.</p>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // === KONFIGURASI ===
        const PASSWORD_GURU = "ESdeN3Turen";
        // Link CSV "Published to Web" dari Google Sheets Anda
        // Perhatikan format CSV pada link yang diberikan user
        const URL_HADIR = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRtXEIEf_S5y3BtqvElCT4KAExMTd-c52Z3WRaD63xMx1rahPgzkaTUd5yV6Yts61JVvwS1OS8tpdMA/pub?gid=637918317&single=true&output=csv";
        const URL_IZIN = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRtXEIEf_S5y3BtqvElCT4KAExMTd-c52Z3WRaD63xMx1rahPgzkaTUd5yV6Yts61JVvwS1OS8tpdMA/pub?gid=1154260962&single=true&output=csv";

        // Variable Global
        let allData = [];
        let uniqueClasses = new Set();
        let isDataLoaded = false;

        // === FUNGSI UTAMA (INIT & FETCH) ===
        
        // Panggil saat halaman diload untuk setting tanggal default filter
        window.onload = function() {
            const today = new Date();
            const monthStr = today.toISOString().slice(0, 7); // YYYY-MM
            document.getElementById('filter-bulan').value = monthStr;
        };

        // Switch Tab Login
        function switchTab(role) {
            const btnGuru = document.getElementById('btn-tab-guru');
            const btnWali = document.getElementById('btn-tab-wali');
            const formGuru = document.getElementById('form-guru');
            const formWali = document.getElementById('form-wali');

            if(role === 'guru') {
                btnGuru.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                btnGuru.classList.remove('text-gray-500');
                btnWali.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                btnWali.classList.add('text-gray-500');
                
                formGuru.classList.remove('hidden');
                formWali.classList.add('hidden');
            } else {
                btnWali.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                btnWali.classList.remove('text-gray-500');
                btnGuru.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                btnGuru.classList.add('text-gray-500');
                
                formWali.classList.remove('hidden');
                formGuru.classList.add('hidden');
            }
        }

        // Fetch Data dari Google Sheets
        async function loadData() {
            if(isDataLoaded) return; // Mencegah fetch berulang jika sudah ada data

            Swal.fire({
                title: 'Mengambil Data...',
                html: 'Mohon tunggu sebentar',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading() }
            });

            try {
                // Fetch kedua URL secara paralel
                const [respHadir, respIzin] = await Promise.all([
                    fetch(URL_HADIR).then(r => r.text()),
                    fetch(URL_IZIN).then(r => r.text())
                ]);

                // Parse CSV
                const dataHadir = parseGoogleCSV(respHadir, 'Hadir');
                const dataIzin = parseGoogleCSV(respIzin, 'Izin/Sakit');

                // Gabungkan dan Urutkan (Terbaru di atas)
                allData = [...dataHadir, ...dataIzin].sort((a, b) => b.timestamp - a.timestamp);
                
                // Ekstrak Kelas Unik untuk Filter
                allData.forEach(item => {
                    if(item.kelas && item.kelas.trim() !== '-') uniqueClasses.add(item.kelas);
                });
                updateClassOptions();
                
                isDataLoaded = true;
                Swal.close();
                
                // Update timestamp UI
                const now = new Date();
                document.getElementById('last-update-guru').innerText = "Data diperbarui: " + now.toLocaleString('id-ID');

            } catch (error) {
                console.error(error);
                Swal.fire('Gagal!', 'Terjadi kesalahan saat mengambil data. Pastikan link CSV benar.', 'error');
            }
        }

        // Parser Pintar untuk Google Form CSV
        function parseGoogleCSV(csvText, defaultStatus) {
            const results = Papa.parse(csvText, { header: true, skipEmptyLines: true });
            
            return results.data.map(row => {
                // Normalisasi Key (Karena header Google Form bisa panjang/berubah)
                let keys = Object.keys(row);
                
                // Cari kolom berdasarkan kata kunci
                let keyTime = keys.find(k => k.toLowerCase().includes('timestamp') || k.toLowerCase().includes('waktu'));
                let keyNama = keys.find(k => k.toLowerCase().includes('nama'));
                let keyKelas = keys.find(k => k.toLowerCase().includes('kelas'));
                // Untuk keterangan: Cari 'Alasan' (di form Izin) atau gunakan '-' jika Hadir
                let keyKet = keys.find(k => k.toLowerCase().includes('alasan') || k.toLowerCase().includes('keterangan') || k.toLowerCase().includes('bukti'));

                let rawDate = row[keyTime] || "";
                let dateObj = new Date(rawDate);
                let validDate = !isNaN(dateObj.getTime()) ? dateObj : new Date();

                return {
                    timestamp: validDate,
                    tanggal: formatDateID(validDate), // Format dd/mm/yyyy
                    bulan: validDate.toISOString().slice(0, 7), // YYYY-MM untuk filter
                    nama: (row[keyNama] || "Tanpa Nama").toUpperCase().trim(),
                    kelas: (row[keyKelas] || "-").toUpperCase().trim(),
                    status: defaultStatus,
                    keterangan: (defaultStatus === 'Hadir') ? 'Hadir Tepat Waktu' : (row[keyKet] || "Izin/Sakit")
                };
            });
        }

        // Helper: Format Tanggal Indonesia (dd/mm/yyyy)
        function formatDateID(date) {
            let d = String(date.getDate()).padStart(2, '0');
            let m = String(date.getMonth() + 1).padStart(2, '0');
            let y = date.getFullYear();
            return `${d}/${m}/${y}`;
        }

        // Update Dropdown Kelas di Dashboard Guru
        function updateClassOptions() {
            const select = document.getElementById('filter-kelas');
            // Keep option "Semua"
            select.innerHTML = '<option value="Semua">Semua Kelas</option>';
            
            // Sort kelas secara alfabetis
            Array.from(uniqueClasses).sort().forEach(cls => {
                let opt = document.createElement('option');
                opt.value = cls;
                opt.innerText = cls;
                select.appendChild(opt);
            });
        }


        // === LOGIKA LOGIN ===

        async function loginGuru() {
            const pass = document.getElementById('pass-guru').value;
            if(pass === PASSWORD_GURU) {
                await loadData(); // Load data dulu
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('dashboard-guru').classList.remove('hidden');
                renderGuruData(); // Render tampilan awal
            } else {
                Swal.fire('Akses Ditolak', 'Password salah, silakan coba lagi.', 'error');
            }
        }

        async function loginWali() {
            const namaInput = document.getElementById('nama-siswa-wali').value.trim();
            if(namaInput.length < 3) {
                Swal.fire('Nama terlalu pendek', 'Masukkan minimal 3 huruf agar pencarian akurat.', 'warning');
                return;
            }

            await loadData(); // Load data

            // Filter data siswa
            const studentData = allData.filter(d => d.nama.includes(namaInput.toUpperCase()));

            if(studentData.length === 0) {
                Swal.fire('Data Tidak Ditemukan', `Belum ada data absensi untuk nama "${namaInput}". Pastikan ejaan benar atau siswa belum mengisi absen.`, 'info');
            } else {
                // Sukses
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('dashboard-wali').classList.remove('hidden');
                renderWaliData(studentData, namaInput.toUpperCase());
            }
        }

        function logout() {
            location.reload();
        }


        // === RENDER DASHBOARD GURU ===

        function renderGuruData() {
            const fBulan = document.getElementById('filter-bulan').value;
            const fKelas = document.getElementById('filter-kelas').value;
            const fNama = document.getElementById('search-guru').value.toUpperCase();
            const tbody = document.getElementById('tabel-guru-body');
            const loading = document.getElementById('loading-guru');
            const empty = document.getElementById('empty-guru');

            // Reset UI
            tbody.innerHTML = '';
            
            // Filter Logic
            let filtered = allData.filter(item => {
                let matchBulan = fBulan ? item.bulan === fBulan : true;
                let matchKelas = fKelas !== "Semua" ? item.kelas === fKelas : true;
                let matchNama = fNama ? item.nama.includes(fNama) : true;
                return matchBulan && matchKelas && matchNama;
            });

            // Update Statistik
            let countHadir = filtered.filter(i => i.status === 'Hadir').length;
            let countIzin = filtered.filter(i => i.status !== 'Hadir').length;
            let total = countHadir + countIzin;
            let persen = total > 0 ? Math.round((countHadir / total) * 100) : 0;

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-hadir').innerText = countHadir;
            document.getElementById('stat-izin').innerText = countIzin;
            document.getElementById('stat-persen').innerText = persen + "%";

            // Update Subtitle Print
            let textBulan = fBulan ? new Date(fBulan).toLocaleDateString('id-ID', {year:'numeric', month:'long'}) : "Semua Bulan";
            document.getElementById('print-subtitle').innerText = `Periode: ${textBulan} | Kelas: ${fKelas}`;

            // Render Tabel
            if(filtered.length === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                filtered.forEach(d => {
                    let badgeColor = d.status === 'Hadir' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-yellow-100 text-yellow-700 border-yellow-200';
                    let row = `
                        <tr class="hover:bg-blue-50 transition border-b border-gray-100">
                            <td class="p-3 whitespace-nowrap font-mono text-xs text-gray-500">${d.tanggal}</td>
                            <td class="p-3 font-semibold text-gray-700">${d.nama}</td>
                            <td class="p-3 text-center"><span class="px-2 py-1 bg-gray-100 rounded text-xs">${d.kelas}</span></td>
                            <td class="p-3 text-center">
                                <span class="px-3 py-1 rounded-full text-xs font-bold border ${badgeColor}">${d.status}</span>
                            </td>
                            <td class="p-3 text-sm text-gray-500 truncate max-w-xs" title="${d.keterangan}">${d.keterangan}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
        }


        // === RENDER DASHBOARD WALI ===

        function renderWaliData(studentData, searchName) {
            // Ambil data terbaru untuk profil
            const latest = studentData[0]; // Karena sudah disort desc
            
            document.getElementById('wali-nama').innerText = latest.nama;
            document.getElementById('wali-kelas').innerText = `Kelas ${latest.kelas}`;

            // Hitung Statistik Anak Ini
            let countHadir = studentData.filter(i => i.status === 'Hadir').length;
            let countIzin = studentData.filter(i => i.status !== 'Hadir').length;
            let total = countHadir + countIzin;
            let persen = total > 0 ? Math.round((countHadir / total) * 100) : 0;

            document.getElementById('wali-hadir').innerText = countHadir;
            document.getElementById('wali-izin').innerText = countIzin;
            document.getElementById('wali-persen').innerText = persen + "%";

            // Render Timeline
            const timelineContainer = document.getElementById('wali-timeline');
            timelineContainer.innerHTML = '';
            
            studentData.forEach(d => {
                let isHadir = d.status === 'Hadir';
                let icon = isHadir ? 'fa-check' : 'fa-notes-medical';
                let colorClass = isHadir ? 'text-green-500 bg-green-50' : 'text-yellow-500 bg-yellow-50';
                
                let html = `
                    <div class="flex items-start gap-4 p-4 rounded-xl border border-gray-100 bg-white shadow-sm hover:shadow-md transition">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center ${colorClass} shrink-0">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-gray-800 text-sm">${d.status}</h4>
                                <span class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded">${d.tanggal}</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 leading-relaxed">
                                ${isHadir ? 'Hadir di sekolah mengikuti pembelajaran.' : 'Keterangan: ' + d.keterangan}
                            </p>
                        </div>
                    </div>
                `;
                timelineContainer.innerHTML += html;
            });
        }

    </script>
</body>
</html>
